<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç©©è„¾ä¹‹åŠ›ï½œå·§æ‰‹åˆ†é¡</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans TC"', 'sans-serif'],
            },
            colors: {
              wood: {
                50: '#fdf8f6',
                100: '#f2e8e5',
                200: '#eaddd7',
                300: '#e0cec7',
                400: '#d2bab0',
                500: '#a18e87',
                600: '#8a7a74',
                700: '#72635e', // Standard Brown Text
                800: '#5e514d', // Dark Brown Text
                900: '#4a403d', // Very Dark Brown
              },
              earth: {
                light: '#fefce8',
                main: '#d9a05b', // Earthy Ochre/Yellow-Brown
                hover: '#b88648',
                dark: '#8d6e3f', // Dark Earth
              }
            },
            animation: {
                'bounce-slight': 'bounce-slight 1s infinite',
            },
            keyframes: {
                'bounce-slight': {
                    '0%, 100%': { transform: 'translateY(-5%)' },
                    '50%': { transform: 'translateY(0)' },
                }
            }
          }
        }
      }
    </script>
    <style>
      body {
        font-family: 'Noto Sans TC', sans-serif;
        background-color: #fdf8f6;
        overflow: hidden; /* Prevent scrolling during drag */
        user-select: none;
        -webkit-user-select: none;
        touch-action: none; /* Prevent browser zooming/scrolling */
      }
      .wood-texture {
        background-color: #fcf6f0;
        background-image: radial-gradient(#d4c5b8 0.5px, transparent 0.5px), radial-gradient(#d4c5b8 0.5px, #fcf6f0 0.5px);
        background-size: 20px 20px;
        background-position: 0 0, 10px 10px;
      }
      /* Utility for hiding elements */
      .hidden-force {
        display: none !important;
      }
      /* Animation classes */
      .fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

      /* Draggable Items */
      .draggable-item {
        touch-action: none;
        cursor: grab;
        position: absolute;
        transition: transform 0.1s;
        filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.15));
      }
      .draggable-item:active {
        cursor: grabbing;
        z-index: 50;
        transform: scale(1.1);
      }
      
      /* Shapes */
      .shape-square {
        width: 60px;
        height: 60px;
        background-color: #5e514d; /* wood-800 */
        border-radius: 8px;
      }
      .shape-circle {
        width: 60px;
        height: 60px;
        background-color: #a18e87; /* wood-500 */
        border-radius: 50%;
      }
      .shape-triangle {
        width: 0;
        height: 0;
        border-left: 35px solid transparent;
        border-right: 35px solid transparent;
        border-bottom: 60px solid #72635e; /* wood-700 */
      }

      /* Bins */
      .bin {
        transition: transform 0.2s, background-color 0.2s;
      }
      .bin.drag-over {
        transform: scale(1.05);
        background-color: #eaddd7; /* wood-200 */
      }
    </style>
</head>
<body class="wood-texture text-wood-900 min-h-screen tracking-wide overflow-hidden">

    <!-- App Container -->
    <div id="app" class="relative w-full h-[100dvh] flex flex-col">
        
        <!-- 1. Start Screen -->
        <div id="screen-start" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-4 overflow-y-auto">
            <div class="max-w-md w-full bg-white/95 backdrop-blur-sm p-8 rounded-2xl shadow-xl border-2 border-wood-300 text-center fade-in my-auto">
                <div class="mb-6"><span class="text-5xl">â›°ï¸</span></div>
                <h1 class="text-3xl md:text-4xl font-black text-wood-900 mb-8 tracking-widest">ç©©è„¾ä¹‹åŠ›ï½œå·§æ‰‹åˆ†é¡</h1>

                <div class="bg-wood-50 p-6 rounded-xl border border-wood-200 text-left mb-8">
                    <p class="text-wood-700 mb-4 font-bold tracking-wider text-lg">
                        è„¾ä¸»è‚Œè‚‰ï¼Œæ°£è¡€å……ç›ˆå‰‡å‹•ä½œéˆå·§ã€‚
                    </p>
                    <p class="text-base text-wood-600 mb-6 leading-relaxed font-medium tracking-wide">
                        åœŸè¡Œå°æ‡‰è‡Ÿè…‘ç‚ºè„¾èˆ‡èƒƒï¼Œè„¾èƒƒèˆ‡è‚Œè‚‰å‹•ä½œçš„å”èª¿ç²¾ç´°åº¦æœ‰é—œã€‚
                    </p>
                    
                    <h2 class="text-xl font-bold text-wood-800 mb-3 border-b border-wood-300 pb-2 flex items-center gap-2 tracking-wider">
                        <span>ğŸ“œ</span> éŠæˆ²è¦å‰‡
                    </h2>
                    <ul class="space-y-3 text-wood-800 leading-relaxed text-base font-medium tracking-wide">
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-earth-dark">â‘ </span>
                            <span>æœ‰ä¸‰ç¨®ç‰©ä»¶ï¼šâ—¼ æ­£æ–¹å½¢ã€â–² ä¸‰è§’å½¢ã€â— åœ“å½¢</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-earth-dark">â‘¡</span>
                            <span>è«‹å°‡é€™ä¸‰ç¨®ç‰©ä»¶åˆ†åˆ¥æ‹–æ›³åˆ°å°æ‡‰çš„å°ç¢—ä¸­ï¼ˆâ–¡ã€â–³ã€â—‹ï¼‰</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="font-bold text-earth-dark">â‘¢</span>
                            <span>è¨ˆæ™‚ 20 ç§’ï¼Œä¾ç…§åˆ†é¡æ­£ç¢ºçš„æ•¸é‡è¨ˆåˆ†</span>
                        </li>
                    </ul>
                </div>

                <button onclick="game.startCountdown()" class="w-full font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-earth-main hover:bg-earth-hover text-white shadow-orange-100 px-8 py-3 text-2xl tracking-widest">
                    é–‹å§‹éŠæˆ²
                </button>
            </div>
        </div>

        <!-- 2. Game Screen (Initially Hidden) -->
        <div id="screen-game" class="hidden-force w-full h-full flex flex-col">
            <!-- Top Bar -->
            <div class="flex-none bg-white/95 backdrop-blur shadow-md border-b border-wood-200 h-16 px-4 z-40">
                <div class="max-w-6xl mx-auto h-full flex items-center justify-between">
                    <!-- Timer -->
                    <div class="flex items-center gap-2 w-1/3">
                        <div id="timer-display" class="font-mono text-3xl font-bold text-wood-900 flex items-center gap-2">
                            <span>â³</span>
                            <span id="timer-val">20</span>s
                        </div>
                    </div>
                    <!-- Empty Title Space (Requested) -->
                    <div class="w-1/3"></div>
                    <!-- Buttons -->
                    <div class="flex items-center justify-end gap-2 w-1/3">
                        <button onclick="ui.showRules()" class="font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 border-2 border-wood-600 text-wood-800 hover:bg-wood-100 px-3 py-1 text-base tracking-wide">
                            è¦å‰‡
                        </button>
                        <button onclick="game.restart()" class="font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-earth-main hover:bg-earth-hover text-white px-3 py-1 text-base tracking-wide">
                            é‡ä¾†
                        </button>
                        <button id="btn-result" onclick="game.finishGame()" disabled class="font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-earth-main hover:bg-earth-hover text-white px-3 py-1 text-base opacity-50 cursor-not-allowed tracking-wide">
                            çµæœ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Area -->
            <div class="flex-1 relative flex flex-col w-full max-w-2xl mx-auto">
                <!-- Spawning Zone (Upper Area) -->
                <div id="spawn-zone" class="flex-1 relative overflow-hidden bg-wood-50/30 m-4 rounded-xl border-2 border-dashed border-wood-200">
                    <!-- Shapes will be injected here -->
                    <div id="shapes-container" class="w-full h-full relative"></div>
                </div>

                <!-- Bins Zone (Lower Area) -->
                <div id="bins-zone" class="h-40 sm:h-48 flex justify-around items-end pb-6 px-4 gap-4">
                    <!-- Square Bin -->
                    <div id="bin-square" data-type="square" class="bin relative w-24 h-24 sm:w-28 sm:h-28 bg-white border-4 border-wood-400 rounded-lg flex flex-col items-center justify-center shadow-inner">
                        <span class="text-4xl text-wood-300 font-bold opacity-50">â–¡</span>
                        <span class="absolute -bottom-8 text-wood-700 font-bold">æ­£æ–¹å½¢</span>
                    </div>
                    <!-- Triangle Bin -->
                    <div id="bin-triangle" data-type="triangle" class="bin relative w-24 h-24 sm:w-28 sm:h-28 bg-white border-4 border-wood-400 rounded-lg flex flex-col items-center justify-center shadow-inner">
                        <span class="text-4xl text-wood-300 font-bold opacity-50">â–³</span>
                        <span class="absolute -bottom-8 text-wood-700 font-bold">ä¸‰è§’å½¢</span>
                    </div>
                    <!-- Circle Bin -->
                    <div id="bin-circle" data-type="circle" class="bin relative w-24 h-24 sm:w-28 sm:h-28 bg-white border-4 border-wood-400 rounded-lg flex flex-col items-center justify-center shadow-inner">
                        <span class="text-4xl text-wood-300 font-bold opacity-50">â—‹</span>
                        <span class="absolute -bottom-8 text-wood-700 font-bold">åœ“å½¢</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Countdown Overlay -->
        <div id="overlay-countdown" class="hidden-force fixed inset-0 z-50 flex items-center justify-center bg-wood-900/40 backdrop-blur-sm">
            <div id="countdown-number" class="text-9xl font-black text-white drop-shadow-lg animate-ping">3</div>
        </div>

        <!-- 4. Result Modal -->
        <div id="modal-result" class="hidden-force fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-900/60 backdrop-blur-sm fade-in">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden p-6 text-center relative">
                <!-- Close X Button -->
                <button onclick="ui.closeResult()" class="absolute top-4 right-4 text-wood-400 hover:text-wood-700 transition-colors p-2 rounded-full hover:bg-wood-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <div class="text-7xl mb-4">â›°ï¸</div>
                <div class="mb-4">
                    <p class="text-wood-600 mb-1 font-bold tracking-wider text-lg">åˆ†é¡çµæœ</p>
                    <p class="text-3xl font-black text-wood-900 tracking-wide">
                        åˆ†é¡ <span id="res-count" class="text-earth-dark">0</span> ä»¶ç‰©ä»¶
                    </p>
                </div>
                <div class="bg-wood-50 p-4 rounded-xl border-2 border-wood-200 mb-4">
                    <h3 id="res-msg" class="text-2xl font-bold text-earth-dark mb-2 tracking-wider"></h3>
                    <p id="res-submsg" class="text-wood-700 text-base mb-3 font-medium tracking-wide"></p>
                    <div class="flex justify-center items-center gap-1 text-wood-400 text-base font-bold bg-white py-2 rounded-lg border border-wood-100">
                        <span>å¾—åˆ†ï¼š</span>
                        <span id="res-score" class="text-3xl text-wood-800">0</span>
                        <span>åˆ†</span>
                    </div>
                </div>
                
                <!-- Scoring Table -->
                <div class="text-left mb-6">
                    <h4 class="text-base font-bold text-wood-500 mb-2 border-b border-wood-100 pb-1 tracking-wider">ğŸ… è¨ˆåˆ†æ–¹å¼</h4>
                    <div class="space-y-2 text-sm text-wood-700 tracking-wide">
                        <div class="flex justify-between items-center whitespace-nowrap gap-2">
                            <span class="font-bold text-earth-dark w-28">åˆ†é¡ 17ï½20 ä»¶</span>
                            <span class="font-bold text-wood-700">3åˆ†</span>
                            <span class="text-right flex-1 text-wood-500 overflow-hidden text-ellipsis">è„¾èƒƒå¼·å¥ï¼Œå‹•ä½œéˆå·§</span>
                        </div>
                        <div class="flex justify-between items-center whitespace-nowrap gap-2">
                            <span class="font-bold text-earth-dark w-28">åˆ†é¡ 10ï½16 ä»¶</span>
                            <span class="font-bold text-wood-700">2åˆ†</span>
                            <span class="text-right flex-1 text-wood-500 overflow-hidden text-ellipsis">è„¾èƒƒä¸éŒ¯ï¼Œç©©ä¸­å¸¶é€²</span>
                        </div>
                        <div class="flex justify-between items-center whitespace-nowrap gap-2">
                            <span class="font-bold text-earth-dark w-28">åˆ†é¡ 0ï½9 ä»¶</span>
                            <span class="font-bold text-wood-700">1åˆ†</span>
                            <span class="text-right flex-1 text-wood-500 overflow-hidden text-ellipsis">è„¾èƒƒè­¦å‘Šï¼Œéœ€å¤šèª¿é¤Š</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-3">
                    <button onclick="game.startCountdown(); ui.closeResult();" class="w-full font-bold rounded-lg transition-all duration-200 shadow-sm active:scale-95 flex items-center justify-center gap-2 bg-earth-main hover:bg-earth-hover text-white shadow-orange-200 px-6 py-2 text-lg tracking-widest">
                        å†ä¾†ä¸€æ¬¡
                    </button>
                </div>
            </div>
        </div>

        <!-- 5. Rules Modal (In-Game) -->
        <div id="modal-rules" class="hidden-force fixed inset-0 z-50 flex items-center justify-center p-4 bg-wood-900/60 backdrop-blur-sm fade-in">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden p-6 relative">
                 <!-- Close X Button -->
                <button onclick="ui.closeRules()" class="absolute top-4 right-4 text-wood-400 hover:text-wood-700 transition-colors p-2 rounded-full hover:bg-wood-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>

                <p class="text-wood-700 mb-2 font-bold text-center tracking-wider text-lg">è„¾ä¸»è‚Œè‚‰ï¼Œæ°£è¡€å……ç›ˆ</p>
                <p class="text-base text-wood-600 mb-6 leading-relaxed text-center font-medium tracking-wide">
                    åœŸè¡Œå°æ‡‰è‡Ÿè…‘ç‚ºè„¾èˆ‡èƒƒï¼Œè„¾èƒƒèˆ‡è‚Œè‚‰å‹•ä½œçš„å”èª¿ç²¾ç´°åº¦æœ‰é—œã€‚
                </p>
                <h3 class="text-2xl font-bold text-center text-wood-800 mb-4 border-b border-wood-100 pb-3 tracking-widest">ğŸ“œ éŠæˆ²è¦å‰‡</h3>
                <ul class="space-y-4 text-wood-800 font-medium tracking-wide">
                    <li class="flex gap-2 text-base"><span class="font-bold text-earth-dark">â‘ </span><span>æœ‰ä¸‰ç¨®ç‰©ä»¶ï¼šâ—¼ æ­£æ–¹å½¢ã€â–² ä¸‰è§’å½¢ã€â— åœ“å½¢</span></li>
                    <li class="flex gap-2 text-base"><span class="font-bold text-earth-dark">â‘¡</span><span>è«‹å°‡é€™ä¸‰ç¨®ç‰©ä»¶åˆ†åˆ¥æ‹–æ›³åˆ°å°æ‡‰çš„å°ç¢—ä¸­ï¼ˆâ–¡ã€â–³ã€â—‹ï¼‰</span></li>
                    <li class="flex gap-2 text-base"><span class="font-bold text-earth-dark">â‘¢</span><span>è¨ˆæ™‚ 20 ç§’ï¼Œä¾ç…§åˆ†é¡æ­£ç¢ºçš„æ•¸é‡è¨ˆåˆ†</span></li>
                </ul>
            </div>
        </div>

    </div>

    <!-- Game Logic -->
    <script>
        const CONFIG = {
            duration: 20,
            maxSpawn: 8, // Max items on screen at once
        };

        const STATE = {
            status: 'START', // START, COUNTDOWN, PLAYING, FINISHED
            timeLeft: CONFIG.duration,
            classifiedCount: 0,
            timerId: null,
            dragItem: null,
            offsetX: 0,
            offsetY: 0,
            startLeft: 0,
            startTop: 0,
            items: [] // Track DOM elements
        };

        const TYPES = ['square', 'triangle', 'circle'];

        // UI Controller
        const ui = {
            els: {
                startScreen: document.getElementById('screen-start'),
                gameScreen: document.getElementById('screen-game'),
                timerDisplay: document.getElementById('timer-display'),
                timerVal: document.getElementById('timer-val'),
                btnResult: document.getElementById('btn-result'),
                overlayCountdown: document.getElementById('overlay-countdown'),
                countdownNum: document.getElementById('countdown-number'),
                modalResult: document.getElementById('modal-result'),
                modalRules: document.getElementById('modal-rules'),
                shapesContainer: document.getElementById('shapes-container'),
                // Result fields
                resCount: document.getElementById('res-count'),
                resMsg: document.getElementById('res-msg'),
                resSubMsg: document.getElementById('res-submsg'),
                resScore: document.getElementById('res-score'),
                // Bins
                bins: {
                    square: document.getElementById('bin-square'),
                    triangle: document.getElementById('bin-triangle'),
                    circle: document.getElementById('bin-circle')
                }
            },

            showGame() {
                this.els.startScreen.classList.add('hidden-force');
                this.els.gameScreen.classList.remove('hidden-force');
            },

            showStart() {
                this.els.startScreen.classList.remove('hidden-force');
                this.els.gameScreen.classList.add('hidden-force');
            },

            updateTimer(val) {
                this.els.timerVal.textContent = val;
                if (val <= 5) {
                    this.els.timerDisplay.classList.add('text-red-600', 'animate-pulse');
                    this.els.timerDisplay.classList.remove('text-wood-900');
                } else {
                    this.els.timerDisplay.classList.remove('text-red-600', 'animate-pulse');
                    this.els.timerDisplay.classList.add('text-wood-900');
                }
            },

            enableResultBtn(enabled) {
                if (enabled) {
                    this.els.btnResult.disabled = false;
                    this.els.btnResult.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    this.els.btnResult.disabled = true;
                    this.els.btnResult.classList.add('opacity-50', 'cursor-not-allowed');
                }
            },

            showCountdown(cb) {
                this.els.overlayCountdown.classList.remove('hidden-force');
                let count = 3;
                this.els.countdownNum.textContent = count;
                
                const int = setInterval(() => {
                    count--;
                    if (count > 0) {
                        this.els.countdownNum.textContent = count;
                    } else {
                        clearInterval(int);
                        this.els.overlayCountdown.classList.add('hidden-force');
                        cb();
                    }
                }, 1000);
            },

            showResult() {
                const result = game.calculateResult();
                this.els.resCount.textContent = STATE.classifiedCount;
                this.els.resMsg.textContent = result.message;
                this.els.resSubMsg.textContent = result.subMessage;
                this.els.resScore.textContent = result.score;
                this.els.modalResult.classList.remove('hidden-force');
            },

            closeResult() {
                this.els.modalResult.classList.add('hidden-force');
            },

            showRules() { this.els.modalRules.classList.remove('hidden-force'); },
            closeRules() { this.els.modalRules.classList.add('hidden-force'); },

            clearShapes() {
                this.els.shapesContainer.innerHTML = '';
            },

            spawnShape() {
                // Random type
                const type = TYPES[Math.floor(Math.random() * TYPES.length)];
                
                const el = document.createElement('div');
                el.classList.add('draggable-item');
                el.dataset.type = type;

                // Visual shape
                const shapeInner = document.createElement('div');
                if (type === 'square') shapeInner.classList.add('shape-square');
                else if (type === 'triangle') shapeInner.classList.add('shape-triangle');
                else if (type === 'circle') shapeInner.classList.add('shape-circle');
                
                el.appendChild(shapeInner);

                // Random Position in container
                // container size is relative, but usually takes up upper 50-60% of screen.
                // We need to ensure it spawns inside.
                const containerW = this.els.shapesContainer.clientWidth;
                const containerH = this.els.shapesContainer.clientHeight;
                
                // padding to avoid edge clipping
                const pad = 70; 
                const maxLeft = containerW - pad;
                const maxTop = containerH - pad;
                
                const left = Math.random() * (maxLeft - 10) + 10;
                const top = Math.random() * (maxTop - 10) + 10;

                el.style.left = `${left}px`;
                el.style.top = `${top}px`;

                // Add Event Listeners for Drag
                this.attachDragEvents(el);

                this.els.shapesContainer.appendChild(el);
            },

            attachDragEvents(el) {
                // Pointer events cover mouse and touch
                el.addEventListener('pointerdown', (e) => {
                    if (STATE.status !== 'PLAYING') return;
                    e.preventDefault(); // prevent scrolling
                    
                    STATE.dragItem = el;
                    el.setPointerCapture(e.pointerId); // Keep events on this element
                    
                    const rect = el.getBoundingClientRect();
                    STATE.offsetX = e.clientX - rect.left;
                    STATE.offsetY = e.clientY - rect.top;
                    
                    // Store original visual position for reversion
                    STATE.startLeft = parseFloat(el.style.left);
                    STATE.startTop = parseFloat(el.style.top);
                    
                    // Temporarily move to body or use fixed positioning logic to drag anywhere?
                    // Actually, easiest is to translate.
                    // But we want to drag FROM spawn-zone TO bins-zone.
                    // If they are separate containers with overflow hidden, dragging out might be clipped.
                    // Solution: When dragging starts, fix position to fixed/absolute on body, or ensure containers don't clip.
                    // Our containers have overflow: visible (default) or flex?
                    // "spawn-zone" has overflow-hidden in my code above. I should remove that if I want to drag out.
                    // Wait, overflow-hidden is usually good for keeping random spawns inside. 
                    // Let's remove overflow-hidden from spawn-zone for dragging to work across divs.
                    document.getElementById('spawn-zone').classList.remove('overflow-hidden');
                    
                    el.style.zIndex = 100;
                });

                el.addEventListener('pointermove', (e) => {
                    if (!STATE.dragItem || STATE.dragItem !== el) return;
                    e.preventDefault();

                    // Calculate new position relative to the container parent (game area)
                    // Or simpler: Update left/top based on pointer delta?
                    // Using clientX/Y directly for absolute positioning inside the closest relative parent.
                    // Our parent is #shapes-container (relative).
                    // We need to convert clientX to container-relative coords.
                    
                    const containerRect = ui.els.shapesContainer.getBoundingClientRect();
                    const x = e.clientX - containerRect.left - STATE.offsetX;
                    const y = e.clientY - containerRect.top - STATE.offsetY;
                    
                    el.style.left = `${x}px`;
                    el.style.top = `${y}px`;

                    // Hit testing visual feedback
                    game.checkHover(e.clientX, e.clientY);
                });

                el.addEventListener('pointerup', (e) => {
                    if (!STATE.dragItem || STATE.dragItem !== el) return;
                    el.releasePointerCapture(e.pointerId);
                    
                    // Check Drop
                    const dropped = game.checkDrop(el, e.clientX, e.clientY);
                    
                    if (!dropped) {
                        // Revert
                        el.style.transition = 'all 0.3s ease-out';
                        el.style.left = `${STATE.startLeft}px`;
                        el.style.top = `${STATE.startTop}px`;
                        setTimeout(() => {
                            el.style.transition = 'transform 0.1s'; // Reset transition
                            el.style.zIndex = '';
                        }, 300);
                    } else {
                        // Success animation handled in logic
                    }

                    STATE.dragItem = null;
                    document.getElementById('spawn-zone').classList.add('overflow-hidden'); // Restore clipping
                    
                    // Clear hover effects
                    Object.values(ui.els.bins).forEach(b => b.classList.remove('drag-over'));
                });
            }
        };

        // Game Logic
        const game = {
            init() {
                STATE.status = 'START';
                ui.showStart();
            },

            startCountdown() {
                ui.showGame();
                ui.closeResult();
                ui.enableResultBtn(false);
                ui.updateTimer(CONFIG.duration);
                ui.clearShapes();
                
                STATE.status = 'COUNTDOWN';
                
                ui.showCountdown(() => {
                    this.startPlaying();
                });
            },

            startPlaying() {
                STATE.status = 'PLAYING';
                STATE.timeLeft = CONFIG.duration;
                STATE.classifiedCount = 0;
                
                // Spawn initial shapes
                for(let i=0; i<5; i++) {
                    setTimeout(() => ui.spawnShape(), i * 100);
                }

                // Start Timer
                if (STATE.timerId) clearInterval(STATE.timerId);
                STATE.timerId = setInterval(() => {
                    STATE.timeLeft--;
                    ui.updateTimer(STATE.timeLeft);
                    
                    // Maintain density
                    const currentCount = ui.els.shapesContainer.children.length;
                    if (currentCount < CONFIG.maxSpawn && Math.random() > 0.7) {
                        ui.spawnShape();
                    }
                    
                    if (STATE.timeLeft <= 0) {
                        this.finishGame();
                    }
                }, 1000);
            },

            checkHover(x, y) {
                // Simple rect overlap check for visual feedback
                Object.values(ui.els.bins).forEach(bin => {
                    const rect = bin.getBoundingClientRect();
                    if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                        bin.classList.add('drag-over');
                    } else {
                        bin.classList.remove('drag-over');
                    }
                });
            },

            checkDrop(el, x, y) {
                const itemType = el.dataset.type;
                let matched = false;

                Object.entries(ui.els.bins).forEach(([binType, binEl]) => {
                    const rect = binEl.getBoundingClientRect();
                    // Check if pointer is within bin
                    if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                        if (itemType === binType) {
                            matched = true;
                            this.handleSuccess(el, binEl);
                        }
                    }
                });

                return matched;
            },

            handleSuccess(el, binEl) {
                STATE.classifiedCount++;
                
                // Animate into bin
                // We move the element to the center of the bin and fade out
                const binRect = binEl.getBoundingClientRect();
                const containerRect = ui.els.shapesContainer.getBoundingClientRect();
                
                // Calculate center relative to container
                const targetX = (binRect.left + binRect.width/2) - containerRect.left - 30; // 30 is half width of shape
                const targetY = (binRect.top + binRect.height/2) - containerRect.top - 30;

                el.style.transition = 'all 0.2s ease-in';
                el.style.left = `${targetX}px`;
                el.style.top = `${targetY}px`;
                el.style.transform = 'scale(0)';
                el.style.opacity = '0';

                // Remove after anim
                setTimeout(() => {
                    el.remove();
                    // Spawn new one to replace
                    ui.spawnShape();
                }, 200);
            },

            finishGame() {
                STATE.status = 'FINISHED';
                clearInterval(STATE.timerId);
                ui.enableResultBtn(true);
                ui.showResult();
            },

            restart() {
                clearInterval(STATE.timerId);
                this.init();
            },

            calculateResult() {
                const count = STATE.classifiedCount;
                if (count >= 17) {
                    return { 
                        score: 3, 
                        message: 'è„¾èƒƒå¼·å¥ï¼Œå‹•ä½œéˆå·§', 
                        subMessage: 'ç¯€å¥ç©©åˆä¿è½ï¼Œå¾ˆçµ¦åŠ›ï¼' 
                    };
                } else if (count >= 10) {
                    return { 
                        score: 2, 
                        message: 'è„¾èƒƒä¸éŒ¯ï¼Œç©©ä¸­å¸¶é€²', 
                        subMessage: 'è¡¨ç¾ä¸éŒ¯ï¼Œæœƒè¶Šä¾†è¶Šé †æ‰‹ï¼' 
                    };
                } else {
                    return { 
                        score: 1, 
                        message: 'è„¾èƒƒè­¦å‘Šï¼Œéœ€å¤šèª¿é¤Š', 
                        subMessage: 'æ²’é—œä¿‚ï¼Œçµ¦è‡ªå·±ä¸€é»æ™‚é–“èª¿æ•´ã€‚' 
                    };
                }
            }
        };

        // Initialize
        game.init();

    </script>
</body>
</html>